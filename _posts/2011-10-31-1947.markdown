---
layout: post
date:      2011-10-31 19:47
title:   Ubuntu Oneiric Ocelot on Sony VAIO VPC Z21X9R
---

I haven&#39;t been screwed so badly by laptop hardware for a long time. Generally, I try to choose hardware which is known to be supported by Linux -- but not this time. And it cost me.<br /><br />Sony VAIO VPC Z21x9r is an ultra-portable (1.2 kg) Sony laptop. It&#39;s got a flash drive, 13&#39;&#39; 1600x900 screen (excellent, by modern standards, something like my old ThinkPad t60 1600x1200 screen), no optical drive. And I got it since it seems to be the current laptop of choice at my employer, Mail.Ru.<br /><br />And as I said, it cost me.<br /><br />1. Ubuntu 10.04 (Long-time support, Lucid Lynx) wouldn&#39;t even boot. I didn&#39;t bother to find out why.<br /><br />2. Ubuntu 11.10 wouldn&#39;t boot either. But this time it was only the video that didn&#39;t work, so I submitted to tweaking the boot parameters (type Esc right after boot loader starts, then F6 and set extra parameters).<br /><br />&#39;nomodeset&#39; solved the problem by forcing vesa driver and 100% screen brightness right upon my tired eyes.<br /><br />3. Well, it wouldn&#39;t install, would it. Thank you the RAID controller used to manage the two flash arrays, my hard drive<br />didn&#39;t look like &#39;/dev/sda&#39; but rather like a bunch of /dev/mapper/isw_haadhabid_Volume0 stuff. I wonder, what is haadhabid supposed to mean? Is it Turkish?<br /><br />By default (unless you happen to notice and change it), the installer wants to store grub boot loader in /dev/sda, and when this fails, it says something like <a href="http://ubuntuforums.org/archive/index.php/t-1559762.html">&quot;This is fatal error&quot;</a>. I figured no better way to solve it than to re-install from scratch having put the right partition for bootloader when on the partitioning screen. For some reason choosing it later on didn&#39;t work. Alright.<br /><br />But then all of the above is peanuts compared to what followed.<br /><br />4. The black screen. Well, yes, I&#39;ve seen it already, but after install I would expect things to work. What&#39;s worse, after &#39;nomodeset&#39; had been added back to kernel startup options, brightness still didn&#39;t work (which alone drove me mad), but suspend/resume didn&#39;t start working either.<br /><br />The first couple of days of hacking and tweaking I basically spent learning the fun of Sony VAIO Z hardware. The thing is, these laptops never worked right on Linux. There is a <a href="https://launchpad.net/~sony-vaio-z-series">whole community</a>&nbsp;of Ubuntu users (or should I say losers) alone trying to make things work since as back as these series first appeared in 2008. Secondly, Sony has a habit of giving remarkably similar model names to computers with vastly different hardware. Thanks to these two factors, the first two days I spent mostly tuning the Radeon video card, which, as it turned out, is not present in my model.<br /><br />Searching by model id also turned out to be a dead end -- VPC Z21X9R is a code name in CIS, and in the reset of Europe it is called VPCZ21***, in New Zealand - VPC Z17 (why?), and so on. So, yes, apart from having Z models with and without Radeon, with and without a hard drive and optical drive, they also call their basically same stuff differently in different regions. Bravo, marketing people!<br /><br />So, to sum up, none of the &quot;Linux on &lt;your laptop here&gt; howtos&quot; related to Sony VAIO Z helped me. Unless you consider help hours of blacklisting modules, tweaking with boot parameters, and ending up with the infamous black screen again. &nbsp;Meh...<br /><br />A weekend passed by, I&#39;d become an experienced Sony hacker. Having been a Linux user since 1999 and all these years really, really, trying to not deal with the crap of hardware support (my dell 6410 still has no working mic), I learned that my chipset is called Intel HM 67, my video hardware is called Intel HD 3000, its Linux driver is called i915, and all this load of hardware doesn&#39;t function properly with any reasonably stable kernel.&nbsp;<br /><br />Another thing I learned was that the black screen auto-magically starts working as soon as it comes back from the power saving mode. That is, first it needs to come *into* the power saving mode.<br /><br />Here&#39;s how you do it:<br />* turn on your laptop<br />* boot it<br />* type in your login and password, blindly<br />* wait 5-10 minutes for the power saver to turn on, avoiding the temptation to click enter or backspace, basically touch anything.<br /><br />Voila, sufficient&nbsp;suspense built and&nbsp; you get a working screen.&nbsp;<br /><br />What a wonderful workaround! After putting &#39;xset dpms force off &amp;&amp; xset dpms force on&#39; into my .xprofile, I at least was able to make stock Ubuntu Oneiric 11.10 work with my screen, with brightness control, and without tweaks with kernel config.<br /><br />The problem is, suspend/resume still didn&#39;t work properly, and I also learned that 3.0.12 kernel consumes almost twice as much power than it should with this hardware, slashing the battery time.<br /><br />So,&nbsp;<br /><br />5. Compiling a custom 3.1 kernel. Compiling an own kernel is never too exciting. I guess you kind of feel the attitude of kernel hackers to the rest of untermensch while doing that, and this is what makes you unhappy. And last time I had to do it was with Red Hat 5.0 (and that&#39;s before they started counting from scratch). Luckily, things didn&#39;t change that much, and a<a href="http://ubuntuforums.org/showthread.php?t=1850544"> fellow loser tutorial</a> saved my nerves. And yes, at first I tried the above-mentioned howto, but the kernel, compiled according to it, as well as a bunch of other 3.0 and 3.1 kernels, would oops on my hardware.<br /><br />Finally, after another couple of days of compiling, oopsing, rebooting, I&#39;m proudly running a kernel based on <a href="http://cgit.freedesktop.org/~keithp/linux/">drm-intel-next</a> branch from 2 days ago. Nothing older than that or closer to the Torvalds tree is good for my baby. A few hours alone were set aside to google for Realtek rt8169 network card firmware, which this kernel uses, and which I found nowhere except a <a href="https://lkml.org/lkml/2011/8/10/23">LKML mailing list message</a> -- so I had to get a git version of linux-firmware.git branch, git apply the mail, and grab the necessary files from there.<br /><br />I hope this kernel is at least somewhat stable -- because if it isn&#39;t, I&#39;m back to the drawing board.<br /><br />Now I can finally &quot;enjoy&quot; my new Ubuntu -- find out why the right mouse button doesn&#39;t work, how to get back my icewm window manager, etc, etc.<br /><br />They say that open source is for those, who want to save money, but have enough time. Well, I guess I&#39;m not. I would happily pay a license fee to a product that saves my time -- but there is really no comparable stock hardware out there which I could use with Linux.<br />So, I guess, I choose what I choose consciously.&nbsp;<br /><br /><br />
